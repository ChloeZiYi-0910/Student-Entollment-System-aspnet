@page
@model StudentEnrollmentSystem.Pages.Admin.ManageCoursesModel
@{
    ViewData["Title"] = "Manage Courses";
}
<link rel="stylesheet" href="~/css/admin-table.css" />
<div class="container mt-3">
    <h1 class="text-center">Manage Courses</h1>
    @if (TempData["Message"] != null)
    {
        <div id="alertMessage" class="alert alert-@TempData["MessageType"]" role="alert">
            @TempData["Message"]
        </div>
    }
    <!-- Add New Course Form -->
    <div class="card mb-4">
        <div class="card-header bg-custom text-white">
            <h4 class="mb-0">Add New Course</h4>
        </div>
        <div class="card-body">
            <form method="post" asp-page-handler="Add">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label asp-for="NewCourse.CourseID" class="form-label">Course ID</label>
                        <input asp-for="NewCourse.CourseID" class="form-control" />
                        <span asp-validation-for="NewCourse.CourseID" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="NewCourse.CourseName" class="form-label">Course Name</label>
                        <input asp-for="NewCourse.CourseName" class="form-control" />
                        <span asp-validation-for="NewCourse.CourseName" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="NewCourse.DayOfWeek" class="form-label">Day</label>
                        <select asp-for="NewCourse.DayOfWeek" class="form-select">
                            <option value="">Select Day</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                        <span asp-validation-for="NewCourse.DayOfWeek" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="NewCourse.StartTime" class="form-label">Start Time</label>
                        <input asp-for="NewCourse.StartTime" type="time" class="form-control" step="3600" oninput="this.value = this.value.slice(0,2) + ':00'" />
                        <span asp-validation-for="NewCourse.StartTime" class="text-danger"></span>
                    </div>
                </div>
                <div class="row g-3 mt-2">

                    <div class="col-md-3">
                        <label asp-for="NewCourse.EndTime" class="form-label">End Time</label>
                        <input asp-for="NewCourse.EndTime" type="time" class="form-control" step="3600" oninput="this.value = this.value.slice(0,2) + ':00'" />
                        <span asp-validation-for="NewCourse.EndTime" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="NewCourse.Major" class="form-label">Major</label>
                        <select asp-for="NewCourse.Major" class="form-select">
                            <option value="">-- Select Major --</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Software Engineering">Software Engineering</option>
                            <option value="Business Administration">Business Administration</option>
                            <option value="Accounting">Accounting</option>
                            <option value="Marketing">Marketing</option>
                        </select>
                        <span asp-validation-for="NewCourse.Major" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="NewCourse.CreditHours" class="form-label">Credit Hours</label>
                        <input asp-for="NewCourse.CreditHours" type="number" min="1" class="form-control" />
                        <span asp-validation-for="NewCourse.CreditHours" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="NewCourse.Venue" class="form-label">Venue</label>
                        <input asp-for="NewCourse.Venue" class="form-control" />
                        <span asp-validation-for="NewCourse.Venue" class="text-danger"></span>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label asp-for="NewCourse.Lecturer" class="form-label">Lecturer</label>
                        <input asp-for="NewCourse.Lecturer" class="form-control"  />
                        <span asp-validation-for="NewCourse.Lecturer" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="NewCourse.Section" class="form-label">Section</label>
                        <input asp-for="NewCourse.Section" class="form-control" />
                        <span asp-validation-for="NewCourse.Section" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="NewCourse.TotalSeats" class="form-label">Total Seats</label>
                        <input asp-for="NewCourse.TotalSeats" type="number" min="1" class="form-control" />
                        <span asp-validation-for="NewCourse.TotalSeats" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="NewCourse.Cost" class="form-label">Cost</label>
                        <input asp-for="NewCourse.Cost" type="number" min="100" class="form-control" />
                        <span asp-validation-for="NewCourse.Cost" class="text-danger"></span>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-4">
                    <div>
                        <button type="submit" class="btn btn-success px-5">Add Course</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Course List -->
    <div class="card">
        <div class="card-header bg-custom text-white">
            <h4 class="mb-0">All Courses</h4>
        </div>
        <div class="card-body">
            <div class="mb-2 row">
                <div class="col-md-3">
                    <input type="text" id="searchCourse" class="form-control" placeholder="Search by Course Name or ID">
                </div>
                <div class="col-md-2">
                    <select id="filterDay" class="form-control">
                        <option value="">All Days</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="filterMajor" class="form-control">
                        <option value="">All Majors</option>
                        @{
                            // Create a HashSet to store unique majors
                            var uniqueMajors = new HashSet<string>();

                            // Add each unique major to the HashSet
                            foreach (var course in Model.Courses)
                            {
                                if (!string.IsNullOrEmpty(course.Major))
                                {
                                    uniqueMajors.Add(course.Major);
                                }
                            }

                            // Output each unique major as an option
                            foreach (var major in uniqueMajors.OrderBy(m => m))
                            {
                                <option value="@major">@major</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="timeRangeStart">Start Time: <span id="startTimeLabel">08:00</span></label>
                    <input type="range" id="timeRangeStart" min="8" max="18" step="1" value="8" class="form-control-range">
                </div>
                <div class="col-md-2">
                    <label for="timeRangeEnd">End Time: <span id="endTimeLabel">18:00</span></label>
                    <input type="range" id="timeRangeEnd" min="8" max="18" step="1" value="18" class="form-control-range">
                </div>
            </div>
            <!-- Clear Filters Button -->
            <div class="mb-4 d-flex justify-content-end">
                <button id="clearFilters" class="btn btn-secondary">Clear Filters</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered custom-table">
                    <thead>
                        <tr>
                            <th>Course ID</th>
                            <th>Name</th>
                            <th>Day</th>
                            <th>Time</th>
                            <th>Major</th>
                            <th>Credits</th>
                            <th>Venue</th>
                            <th>Lecturer</th>
                            <th>Section</th>
                            <th>Cost</th>
                            <th>Seats (Enrolled/Total)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var course in Model.Courses)
                        {
                            <tr id="row-@course.CourseID">
                                <td>@course.CourseID</td>
                                <td>@course.CourseName</td>
                                <td>@course.DayOfWeek</td>
                                <td>@course.StartTime.ToString("hh\\:mm") - @course.EndTime.ToString("hh\\:mm")</td>
                                <td>@course.Major</td>
                                <td>@course.CreditHours</td>
                                <td>@course.Venue</td>
                                <td>@course.Lecturer</td>
                                <td>@course.Section</td>
                                <td>@course.Cost</td>
                                <td>@course.EnrolledCount / @course.TotalSeats</td>
                                <td>
                                    <div class="btn-group">
                                        <button type="button" class="btn edit btn-sm" onclick="window.location.href='/Admin/EditCourse?courseID=@course.CourseID'">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                        <button type="button" class="btn delete btn-sm delete-btn" onclick="showDeleteModal('@course.CourseID', '@course.CourseName')">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>

                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong id="delete-course-name"></strong> (Course ID: <span id="delete-course-id"></span>)?</p>
                </div>
                <div class="modal-footer">
                    <form method="post" asp-page-handler="Delete">
                        <input type="hidden" name="CourseID" id="confirm-delete-course-id" />
                        <button type="submit" class="btn btn-danger">Yes, Delete</button>
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="text-center mt-4">
        <a asp-page="/Admin/AdminHome" class="btn btn-outline-primary">Back to Dashboard</a>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Variables defined at the scope where they're used
    const searchInput = document.getElementById("searchCourse");
    const filterDay = document.getElementById("filterDay");
    const filterMajor = document.getElementById("filterMajor");
    const timeRangeStart = document.getElementById("timeRangeStart");
    const timeRangeEnd = document.getElementById("timeRangeEnd");
    const startTimeLabel = document.getElementById("startTimeLabel");
    const endTimeLabel = document.getElementById("endTimeLabel");
    const clearFiltersButton = document.getElementById("clearFilters");
    
    // Event listeners
    searchInput.addEventListener("input", filterCourses);
    filterDay.addEventListener("change", filterCourses);
    filterMajor.addEventListener("change", filterCourses);
    timeRangeStart.addEventListener("input", updateTimeLabels);
    timeRangeEnd.addEventListener("input", updateTimeLabels);
    timeRangeStart.addEventListener("change", filterCourses);
    timeRangeEnd.addEventListener("change", filterCourses);
    clearFiltersButton.addEventListener("click", clearFilters);
    
    // Update time labels initially
    updateTimeLabels();
    
    // Filter function defined inside DOMContentLoaded
    function filterCourses() {
        const searchValue = searchInput.value.toLowerCase();
        const selectedDay = filterDay.value;
        const selectedMajor = filterMajor.value;
        const startTime = parseInt(timeRangeStart.value);
        const endTime = parseInt(timeRangeEnd.value);
        
        const rows = document.querySelectorAll(".custom-table tbody tr");
        
        rows.forEach(row => {
            const courseID = row.cells[0].textContent.toLowerCase();
            const courseName = row.cells[1].textContent.toLowerCase();
            const courseDay = row.cells[2].textContent.toLowerCase();
            const courseTimeText = row.cells[3].textContent;
            const courseMajor = row.cells[4].textContent.toLowerCase();
            
            // Extract course time from format like "08:00 - 10:00"
            const timeMatch = courseTimeText.match(/(\d+):(\d+)\s*-\s*(\d+):(\d+)/);
            let courseStartHour = 8; // Default values
            let courseEndHour = 18;
            
            if (timeMatch) {
                courseStartHour = parseInt(timeMatch[1]);
                courseEndHour = parseInt(timeMatch[3]);
            }
            
            // Check all filter conditions
            const matchesSearch = courseName.includes(searchValue) || courseID.includes(searchValue);
            const matchesDay = selectedDay === "" || courseDay === selectedDay.toLowerCase();
            const matchesMajor = selectedMajor === "" || courseMajor === selectedMajor.toLowerCase();
            const matchesTime = courseStartHour >= startTime && courseEndHour <= endTime;
            
            if (matchesSearch && matchesDay && matchesMajor && matchesTime) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }
    
    function updateTimeLabels() {
        startTimeLabel.textContent = formatTime(timeRangeStart.value);
        endTimeLabel.textContent = formatTime(timeRangeEnd.value);
    }
    
    function formatTime(hour) {
        return `${hour.padStart(2, '0')}:00`;
    }
    
    function clearFilters() {
        searchInput.value = "";
        filterDay.value = "";
        filterMajor.value = "";
        timeRangeStart.value = 8;
        timeRangeEnd.value = 18;
        updateTimeLabels();
        filterCourses();
    }
});

// This function needs to be in the global scope since it's called from onclick attributes
function showDeleteModal(courseId, courseName) {
    document.getElementById("delete-course-name").innerText = courseName;
    document.getElementById("delete-course-id").innerText = courseId;
    document.getElementById("confirm-delete-course-id").value = courseId;
    var deleteModal = new bootstrap.Modal(document.getElementById("deleteConfirmationModal"));
    deleteModal.show();
}

// Auto-hide alert message
setTimeout(function () {
    var alertBox = document.getElementById("alertMessage");
    if (alertBox) {
        alertBox.style.display = "none";
    }
}, 3000); // 3 seconds
</script>

<style>
    /* Table Styling */
    .custom-table {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    }

        .custom-table td {
            vertical-align: middle;
        }

    thead {
        text-align: center;    
    }

    .form-label {
        font-weight: 500;
    }
</style>